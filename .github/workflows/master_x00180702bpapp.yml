# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy ASP.Net Core app to Azure Web App - x00180702bpApp
env:
  URI: https://bloodpressurecalculator.azurewebsites.net 
  AZURE_WEBAPP_NAME_Test_Slot: Testing (BloodPressureCalculator/Testing)
  
on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '5.0.x'
          include-prerelease: true
          
      - name: Install dependencies
        run: dotnet restore

      - name: Build with dotnet
        run: dotnet build --configuration Release
      - name: Run unit tests
        run: dotnet test bpUnitTestProject/bpUnitTestProject.csproj --no-restore --collect "Code coverage" -l:trx
        
      - name: Publish Unit Test Results
        uses: dorny/test-reporter@v1
        with:
          artifact: ''
          name: MS Tests                  
          path: '**.trx'
          reporter: 'dotnet-trx' 
          
  create_staging_slot:
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}   
          
      - name: Create slot on staging site
        run: az webapp deployment slot create --name BloodPressureCalculator --resource-group BloodPressureCalculator --slot Testing
        
 
  build_test_deploy:
        name: 'FunctionApp Build, Test & Deploy'
        runs-on: ubuntu-latest
        steps:
          - name: Checkout the repo
            uses: actions/checkout@v2

          - name: Get FunctionApp publish profile
            id: publishprofile
            uses: aliencube/publish-profile-actions@v1
            env:
              AZURE_CREDENTIALS: $\{\{ secrets.AZURE_CREDENTIALS \}\}
            with:
              resourceGroupName: $\{\{ secrets.RESOURCE_GROUP_NAME_DEV \}\}
              appName: $\{\{ secrets.RESOURCE_FUNCTIONAPP_NAME_DEV \}\}
    
          - name: Deploy FunctionApp
            uses: azure/webapps-deploy@v2
            with:
              app-name: $\{\{ secrets.RESOURCE_FUNCTIONAPP_NAME_DEV \}\}
              package: published
              publish-profile: $\{\{ steps.publishprofile.outputs.profile \}\}
    
          - name: Reset FunctionApp publish profile
            uses: aliencube/publish-profile-actions@v1
            env:
              AZURE_CREDENTIALS: $\{\{ secrets.AZURE_CREDENTIALS_DEV \}\}
            with:
              resourceGroupName: $\{\{ secrets.RESOURCE_GROUP_NAME_DEV \}\}
              appName: $\{\{ secrets.RESOURCE_FUNCTIONAPP_NAME_DEV \}\}
              reset: true  
  
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: 'Testing'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
